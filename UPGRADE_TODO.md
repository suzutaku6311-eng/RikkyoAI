# Webツールアップグレード TODOリスト

このドキュメントは、Rikkyo AIシステムのアップグレード計画を詳細にまとめたものです。

---

## Phase 1: 基盤の安定化（最優先）

### 1.1 RAG検索機能の修正

#### 1.1.1 Supabase RPC関数の作成
- [ ] Supabase DashboardでSQL Editorを開く
- [ ] `match_chunks`関数を作成
  ```sql
  CREATE OR REPLACE FUNCTION match_chunks(
    query_embedding vector(3072),
    match_threshold float,
    match_count int
  )
  RETURNS TABLE (
    id uuid,
    content text,
    document_id uuid,
    chunk_index int,
    similarity float
  )
  LANGUAGE plpgsql
  AS $$
  BEGIN
    RETURN QUERY
    SELECT
      chunks.id,
      chunks.content,
      chunks.document_id,
      chunks.chunk_index,
      1 - (chunks.embedding <=> query_embedding) as similarity
    FROM chunks
    WHERE 1 - (chunks.embedding <=> query_embedding) > match_threshold
    ORDER BY chunks.embedding <=> query_embedding
    LIMIT match_count;
  END;
  $$;
  ```
- [ ] RPC関数の動作確認
- [ ] `lib/rag.ts`の`searchSimilarChunks`関数をRPC関数を使用するように修正
- [ ] テスト実行して検索結果が正しく返ることを確認

#### 1.1.2 Embedding取得方法の修正
- [ ] 現在のEmbedding取得方法を確認
- [ ] pgvector型が配列として正しく取得できているか確認
- [ ] 必要に応じて変換処理を追加
- [ ] エラーハンドリングの改善

#### 1.1.3 類似度スコアの可視化
- [ ] 検索結果に類似度スコアを追加
- [ ] UIに類似度を表示（プログレスバーやパーセンテージ）
- [ ] 類似度が低い結果をフィルタリングするオプション追加

### 1.2 Supabase Storageの設定確認

#### 1.2.1 Storageバケットの確認
- [ ] Supabase DashboardでStorageを確認
- [ ] 「documents」バケットが存在するか確認
- [ ] 存在しない場合は作成（公開バケットとして）
- [ ] バケット内のファイル一覧を確認

#### 1.2.2 公開ポリシーの設定
- [ ] Storageバケットの公開読み取りポリシーを確認
- [ ] 以下のSQLを実行して公開ポリシーを設定：
  ```sql
  CREATE POLICY "Public Access"
  ON storage.objects FOR SELECT
  USING (bucket_id = 'documents');
  ```
- [ ] ポリシーが正しく設定されているか確認

#### 1.2.3 既存文書のStorage移行
- [ ] 既存の文書でStorageに保存されていないものを確認
- [ ] 必要に応じて再アップロード機能を実装
- [ ] または、バッチ移行スクリプトを作成

#### 1.2.4 file_pathカラムの確認
- [ ] `documents`テーブルに`file_path`カラムが存在するか確認
- [ ] 存在しない場合は追加：
  ```sql
  ALTER TABLE documents 
  ADD COLUMN IF NOT EXISTS file_path TEXT;
  ```
- [ ] 既存文書の`file_path`を更新

### 1.3 エラーハンドリングの強化

#### 1.3.1 APIエラーハンドリングの統一
- [ ] すべてのAPIエンドポイントでエラーハンドリングを統一
- [ ] エラーレスポンスの形式を統一
- [ ] エラーログの詳細化

#### 1.3.2 フロントエンドのエラー表示改善
- [ ] エラーメッセージをユーザーフレンドリーに
- [ ] エラーの種類に応じた適切なメッセージ表示
- [ ] リトライ機能の追加

---

## Phase 2: UX改善（高優先度）

### 2.1 検索結果の改善

#### 2.1.1 根拠文書の表示
- [ ] 検索結果に文書タイトルとファイル名を表示
- [ ] どの文書のどの部分を参照したかを表示
- [ ] 文書へのリンクを追加

#### 2.1.2 類似度スコアの表示
- [ ] 検索結果に類似度スコアを表示
- [ ] プログレスバーやパーセンテージで可視化
- [ ] 類似度が低い結果を非表示にするオプション

#### 2.1.3 検索結果のハイライト表示
- [ ] 検索キーワードをハイライト
- [ ] 関連する部分を強調表示
- [ ] チャンクの前後の文脈を表示

#### 2.1.4 検索結果のページネーション
- [ ] 検索結果が多い場合のページネーション実装
- [ ] 1ページあたりの表示件数を設定可能に
- [ ] 「もっと見る」ボタンの追加

### 2.2 検索履歴機能

#### 2.2.1 検索履歴の保存
- [ ] `search_history`テーブルを作成
  ```sql
  CREATE TABLE search_history (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    question TEXT NOT NULL,
    answer TEXT NOT NULL,
    chunks_used JSONB,
    created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
  );
  ```
- [ ] 検索時に履歴を保存するAPI実装
- [ ] 履歴一覧を表示するUI実装

#### 2.2.2 履歴からの再検索
- [ ] 履歴から質問を再実行できる機能
- [ ] 履歴の編集機能
- [ ] 履歴の削除機能

#### 2.2.3 お気に入り機能
- [ ] お気に入りテーブルを作成
- [ ] 検索結果をお気に入りに追加する機能
- [ ] お気に入り一覧を表示するUI

### 2.3 ローディング状態の改善

#### 2.3.1 プログレスバーの追加
- [ ] アップロード時のプログレスバー実装
- [ ] 検索時のプログレスバー実装
- [ ] ステップごとの進捗表示

#### 2.3.2 ステップごとの進捗表示
- [ ] 「テキスト抽出中...」
- [ ] 「チャンク分割中...」
- [ ] 「Embedding生成中...」
- [ ] 「検索中...」
- [ ] 「回答生成中...」

#### 2.3.3 スケルトンローディング
- [ ] 検索結果のスケルトンローディング実装
- [ ] 文書一覧のスケルトンローディング実装
- [ ] より自然なローディング体験の提供

---

## Phase 3: 機能拡張（中優先度）

### 3.1 文書形式の拡張

#### 3.1.1 DOCXファイル対応
- [ ] `mammoth`または`docx`パッケージをインストール
- [ ] DOCXファイルのテキスト抽出機能を実装
- [ ] `app/api/admin/ingest/route.ts`にDOCX処理を追加
- [ ] アップロードUIでDOCXファイルを許可
- [ ] テスト実行

#### 3.1.2 TXTファイル対応
- [ ] TXTファイルのテキスト抽出機能を実装
- [ ] `app/api/admin/ingest/route.ts`にTXT処理を追加
- [ ] アップロードUIでTXTファイルを許可
- [ ] テスト実行

#### 3.1.3 画像からのOCR
- [ ] `tesseract.js`または類似ライブラリを検討
- [ ] 画像ファイル（PNG、JPG）のアップロード対応
- [ ] OCR機能の実装
- [ ] 抽出したテキストの品質確認機能

### 3.2 高度な検索機能

#### 3.2.1 文書タイプでのフィルタリング
- [ ] 検索UIにフィルタリングオプションを追加
- [ ] PDF/DOCX/TXTでフィルタリング
- [ ] フィルタリング状態の保持

#### 3.2.2 日付範囲検索
- [ ] アップロード日時でのフィルタリング
- [ ] 日付範囲選択UIの実装
- [ ] 検索APIに日付フィルタを追加

#### 3.2.3 複数キーワード検索
- [ ] 複数キーワードのAND/OR検索
- [ ] 検索UIの改善
- [ ] 検索ロジックの実装

#### 3.2.4 文書メタデータ検索
- [ ] タイトル、ファイル名での検索
- [ ] メタデータ検索UIの実装
- [ ] 検索APIの拡張

### 3.3 管理機能の強化

#### 3.3.1 Embedding再生成機能
- [ ] 文書一覧に「再生成」ボタンを追加
- [ ] Embedding再生成APIの実装
- [ ] 再生成の進捗表示
- [ ] エラーハンドリング

#### 3.3.2 文書更新機能
- [ ] 文書のタイトル編集機能
- [ ] 文書の更新API実装
- [ ] 更新時にEmbeddingも再生成するオプション

#### 3.3.3 バッチアップロード
- [ ] 複数ファイルの同時アップロード対応
- [ ] アップロード進捗の表示
- [ ] エラー時の個別処理

#### 3.3.4 文書のカテゴリ分類
- [ ] `documents`テーブルに`category`カラムを追加
- [ ] カテゴリ選択UIの実装
- [ ] カテゴリでのフィルタリング機能

---

## Phase 4: セキュリティ・運用（重要）

### 4.1 認証機能の追加

#### 4.1.1 Supabase Authの設定
- [ ] Supabase Dashboardで認証を有効化
- [ ] 認証プロバイダーの設定（Email、Google等）
- [ ] 認証UIコンポーネントの実装

#### 4.1.2 ロールベースアクセス制御（RBAC）
- [ ] ユーザーテーブルに`role`カラムを追加
- [ ] 管理者/一般ユーザーのロール定義
- [ ] ロールに応じたアクセス制御実装

#### 4.1.3 文書ごとの閲覧権限設定
- [ ] `documents`テーブルに`access_control`カラムを追加
- [ ] 公開/非公開/特定ユーザーの設定
- [ ] 権限チェック機能の実装

#### 4.1.4 認証ガードの実装
- [ ] 保護されたルートの認証チェック
- [ ] 未認証ユーザーのリダイレクト
- [ ] セッション管理

### 4.2 監視・ログ

#### 4.2.1 エラートラッキング（Sentry等）
- [ ] Sentryアカウントの作成
- [ ] Sentry SDKのインストールと設定
- [ ] エラーの自動通知設定
- [ ] エラーダッシュボードの確認

#### 4.2.2 アクセスログの記録
- [ ] `access_logs`テーブルを作成
- [ ] APIアクセスのログ記録
- [ ] ユーザー行動のログ記録
- [ ] ログ分析ダッシュボードの作成

#### 4.2.3 パフォーマンス監視
- [ ] Vercel Analyticsの設定
- [ ] API応答時間の監視
- [ ] パフォーマンスボトルネックの特定
- [ ] 最適化の実施

#### 4.2.4 使用量の可視化
- [ ] OpenAI API使用量の追跡
- [ ] Supabase使用量の追跡
- [ ] コスト分析ダッシュボードの作成
- [ ] アラート設定

### 4.3 バックアップ・復旧

#### 4.3.1 データベースの定期バックアップ
- [ ] Supabaseの自動バックアップ設定確認
- [ ] 手動バックアップスクリプトの作成
- [ ] バックアップの検証

#### 4.3.2 災害復旧計画
- [ ] 復旧手順書の作成
- [ ] バックアップからの復旧テスト
- [ ] 復旧時間の目標設定

---

## Phase 5: UI/UX改善

### 5.1 レスポンシブデザインの最適化

#### 5.1.1 モバイル対応の改善
- [ ] モバイルでのレイアウト確認
- [ ] タッチ操作の最適化
- [ ] モバイルメニューの実装

#### 5.1.2 タブレット対応
- [ ] タブレットサイズでのレイアウト確認
- [ ] タブレット向けのUI調整

#### 5.1.3 画面サイズ別の最適化
- [ ] ブレークポイントの見直し
- [ ] 各画面サイズでのテスト
- [ ] ユーザビリティテスト

### 5.2 ダークモード対応

#### 5.2.1 テーマシステムの実装
- [ ] テーマコンテキストの作成
- [ ] ダークモード用のカラーパレット定義
- [ ] テーマ切り替え機能の実装

#### 5.2.2 ユーザー設定の保存
- [ ] テーマ設定をlocalStorageに保存
- [ ] ユーザー設定テーブルの作成（オプション）
- [ ] 設定の永続化

#### 5.2.3 木目調デザインのダークモード対応
- [ ] ダークモード用の木目調カラー定義
- [ ] 各コンポーネントのダークモード対応
- [ ] アニメーションの調整

### 5.3 アニメーション・インタラクション

#### 5.3.1 スムーズなトランジション
- [ ] ページ遷移のアニメーション
- [ ] モーダルのアニメーション
- [ ] リストアイテムのアニメーション

#### 5.3.2 ホバーエフェクト
- [ ] ボタンのホバーエフェクト改善
- [ ] カードのホバーエフェクト
- [ ] リンクのホバーエフェクト

#### 5.3.3 ローディングアニメーション
- [ ] カスタムローディングアニメーション
- [ ] スケルトンローディングの改善
- [ ] プログレスインジケーターの改善

---

## Phase 6: 高度な機能（将来の拡張）

### 6.1 外部サービス連携

#### 6.1.1 Notion連携
- [ ] Notion APIの調査
- [ ] Notion認証の実装
- [ ] Notionページの自動同期機能
- [ ] 同期スケジュールの設定

#### 6.1.2 Google Drive連携
- [ ] Google Drive APIの調査
- [ ] Google認証の実装
- [ ] Google Driveファイルの自動同期機能
- [ ] フォルダ選択機能

#### 6.1.3 Slack連携
- [ ] Slack APIの調査
- [ ] Slack認証の実装
- [ ] Slack通知機能
- [ ] Slackから検索できる機能

### 6.2 会話機能

#### 6.2.1 チャット形式のUI
- [ ] チャットUIコンポーネントの実装
- [ ] メッセージ履歴の表示
- [ ] 入力フィールドの実装

#### 6.2.2 会話履歴の永続化
- [ ] `conversations`テーブルを作成
- [ ] 会話履歴の保存機能
- [ ] 会話履歴の読み込み機能

#### 6.2.3 コンテキストの保持
- [ ] 会話のコンテキスト管理
- [ ] 前の質問を参照した回答生成
- [ ] コンテキストウィンドウの管理

### 6.3 分析・レポート機能

#### 6.3.1 よく検索される質問の分析
- [ ] 検索履歴の分析機能
- [ ] 人気の質問ランキング
- [ ] トレンド分析

#### 6.3.2 文書の使用状況レポート
- [ ] 文書ごとのアクセス数
- [ ] 文書ごとの検索回数
- [ ] 使用状況ダッシュボード

#### 6.3.3 ユーザー行動分析
- [ ] ユーザー行動の追跡
- [ ] 行動パターンの分析
- [ ] 改善提案の自動生成

---

## 技術的な改善点

### パフォーマンス

#### ベクトル検索のインデックス最適化
- [ ] pgvectorインデックスの作成
- [ ] インデックスのパラメータ調整
- [ ] 検索速度の測定と改善

#### キャッシュ戦略の実装
- [ ] 検索結果のキャッシュ
- [ ] Embeddingのキャッシュ
- [ ] キャッシュの無効化戦略

#### チャンクサイズの最適化
- [ ] 現在のチャンクサイズの効果測定
- [ ] 最適なチャンクサイズの決定
- [ ] チャンクサイズの調整

### コード品質

#### 型安全性の向上
- [ ] TypeScriptのstrictモード有効化
- [ ] 型定義の見直し
- [ ] 型エラーの解消

#### エラーハンドリングの統一
- [ ] エラークラスの定義
- [ ] エラーハンドリングの統一
- [ ] エラーログの標準化

#### テストコードの追加
- [ ] 単体テストの追加
- [ ] 統合テストの追加
- [ ] E2Eテストの追加
- [ ] テストカバレッジの目標設定

### スケーラビリティ

#### 大量文書への対応
- [ ] パフォーマンステストの実施
- [ ] ボトルネックの特定
- [ ] 最適化の実施

#### 並列処理の最適化
- [ ] Embedding生成の並列化
- [ ] 検索処理の並列化
- [ ] バッチ処理の最適化

#### ストレージ容量の管理
- [ ] ストレージ使用量の監視
- [ ] 古いファイルの自動削除
- [ ] ストレージ容量のアラート設定

---

## 実装の優先順位まとめ

### 最優先（1-2週間）
1. ✅ RAG検索機能の修正
2. ✅ Supabase Storageの設定確認
3. ✅ エラーハンドリングの強化

### 高優先度（2-3週間）
4. ✅ 検索結果の改善
5. ✅ 検索履歴機能
6. ✅ ローディング状態の改善

### 中優先度（3-4週間）
7. ✅ 文書形式の拡張（DOCX、TXT）
8. ✅ 高度な検索機能
9. ✅ 管理機能の強化

### セキュリティ・運用（2-3週間）
10. ✅ 認証機能の追加
11. ✅ 監視・ログ

### 高度な機能（継続的）
12. ✅ 外部サービス連携
13. ✅ 会話機能
14. ✅ 分析・レポート機能

---

## 注意事項

- 各フェーズは独立して実装可能ですが、Phase 1は最優先で完了させることを推奨します
- 実装前に必ず要件を確認し、設計を検討してください
- 実装後は必ずテストを実施し、動作確認を行ってください
- 本番環境へのデプロイ前に、ステージング環境で十分なテストを行ってください

---

## 更新履歴

- 2025-11-26: 初版作成

