# èªè¨¼ãƒ»èªå¯æ©Ÿèƒ½ å®Ÿè£…ã‚µãƒãƒªãƒ¼

**å®Ÿè£…æ—¥**: 2024å¹´11æœˆ28æ—¥  
**ãƒãƒ¼ã‚¸ãƒ§ãƒ³**: Phase 1-3 å®Œäº†

---

## âœ… å®Ÿè£…å®Œäº†é …ç›®

### Phase 1: åŸºæœ¬èªè¨¼æ©Ÿèƒ½

1. âœ… **ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³**
   - `migrations/create_auth_tables.sql` ã‚’ä½œæˆ
   - `user_profiles`, `access_logs`, `document_permissions` ãƒ†ãƒ¼ãƒ–ãƒ«
   - `documents` ãƒ†ãƒ¼ãƒ–ãƒ«ã®æ‹¡å¼µï¼ˆ`created_by`, `is_public`, `access_level`ï¼‰
   - Row Level Security (RLS) ãƒãƒªã‚·ãƒ¼ã®å®Ÿè£…

2. âœ… **èªè¨¼API**
   - `/api/auth/login` - ãƒ­ã‚°ã‚¤ãƒ³
   - `/api/auth/logout` - ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ
   - `/api/auth/me` - ç¾åœ¨ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±å–å¾—

3. âœ… **èªè¨¼ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢**
   - `middleware.ts` ã§ä¿è­·ãƒ‘ã‚¹ã®èªè¨¼ãƒã‚§ãƒƒã‚¯
   - æœªèªè¨¼ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ `/login` ã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ

4. âœ… **UIå®Ÿè£…**
   - ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ (`/app/login/page.tsx`)
   - èªè¨¼ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆ (`contexts/AuthContext.tsx`)
   - ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ãƒãƒ¼ã®èªè¨¼å¯¾å¿œ

5. âœ… **èªè¨¼ãƒ˜ãƒ«ãƒ‘ãƒ¼**
   - `lib/auth-helpers.ts` ã§èªè¨¼ãƒ»æ¨©é™ãƒã‚§ãƒƒã‚¯é–¢æ•°
   - `lib/supabase-client.ts` ã§Supabaseã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆè¨­å®š

### Phase 2: ãƒ­ãƒ¼ãƒ«ãƒ™ãƒ¼ã‚¹ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡ï¼ˆRBACï¼‰

1. âœ… **ãƒ­ãƒ¼ãƒ«å®šç¾©**
   - `user` - ä¸€èˆ¬ãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼ˆæ–‡æ›¸æ¤œç´¢ãƒ»é–²è¦§ã®ã¿ï¼‰
   - `admin` - ç®¡ç†è€…ï¼ˆæ–‡æ›¸ç®¡ç†æ©Ÿèƒ½ï¼‰
   - `super_admin` - ã‚¹ãƒ¼ãƒ‘ãƒ¼ç®¡ç†è€…ï¼ˆå…¨æ©Ÿèƒ½ï¼‰

2. âœ… **APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã®æ¨©é™ãƒã‚§ãƒƒã‚¯**
   - `/api/admin/ingest` - ç®¡ç†è€…ã®ã¿
   - `/api/admin/documents` - ç®¡ç†è€…ã®ã¿
   - `/api/admin/documents/[id]` - ç®¡ç†è€…ã®ã¿
   - `/api/admin/documents/[id]/regenerate` - ç®¡ç†è€…ã®ã¿
   - `/api/admin/documents/[id]/view` - ç®¡ç†è€…ã®ã¿ï¼ˆãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ï¼‰
   - `/api/ask` - èªè¨¼ãƒ¦ãƒ¼ã‚¶ãƒ¼å…¨å“¡
   - `/api/search-history` - èªè¨¼ãƒ¦ãƒ¼ã‚¶ãƒ¼å…¨å“¡ï¼ˆè‡ªåˆ†ã®å±¥æ­´ã®ã¿ï¼‰

3. âœ… **UIã®æ¨©é™ã«å¿œã˜ãŸè¡¨ç¤ºåˆ¶å¾¡**
   - ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ãƒãƒ¼ã§ç®¡ç†è€…ã®ã¿è¡¨ç¤ºã•ã‚Œã‚‹ãƒªãƒ³ã‚¯
   - `/admin/documents` ã¨ `/admin/upload` ã§ç®¡ç†è€…æ¨©é™ãƒã‚§ãƒƒã‚¯

### Phase 3: æ–‡æ›¸ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡

1. âœ… **æ–‡æ›¸ã®ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰æ¨©é™ãƒã‚§ãƒƒã‚¯**
   - ç®¡ç†è€…ã®ã¿ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰å¯èƒ½

2. âœ… **æ–‡æ›¸ã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰æ¨©é™ãƒã‚§ãƒƒã‚¯**
   - ç®¡ç†è€…ã®ã¿ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å¯èƒ½
   - `created_by` ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’è‡ªå‹•è¨­å®š

3. âœ… **RLSãƒãƒªã‚·ãƒ¼ã®å®Ÿè£…**
   - å…¬é–‹æ–‡æ›¸ã¯å…¨èªè¨¼ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒé–²è¦§å¯èƒ½
   - ç®¡ç†è€…ã¯å…¨æ–‡æ›¸ã‚’é–²è¦§å¯èƒ½
   - ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯è‡ªåˆ†ãŒä½œæˆã—ãŸæ–‡æ›¸ã‚’é–²è¦§å¯èƒ½

---

## ğŸ“‹ æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ï¼ˆæœªå®Ÿè£…ï¼‰

### Phase 4: ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†æ©Ÿèƒ½ï¼ˆä¸­å„ªå…ˆåº¦ï¼‰

- [ ] ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§è¡¨ç¤º
- [ ] ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²æ©Ÿèƒ½ï¼ˆç®¡ç†è€…ã®ã¿ï¼‰
- [ ] ãƒ¦ãƒ¼ã‚¶ãƒ¼ç·¨é›†ãƒ»å‰Šé™¤æ©Ÿèƒ½
- [ ] ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒªã‚»ãƒƒãƒˆæ©Ÿèƒ½

### Phase 5: ç›£æŸ»ãƒ­ã‚°ï¼ˆä½å„ªå…ˆåº¦ï¼‰

- [ ] ã‚¢ã‚¯ã‚»ã‚¹ãƒ­ã‚°ãƒ†ãƒ¼ãƒ–ãƒ«ã®ä½œæˆï¼ˆâœ… å®Œäº†ï¼‰
- [ ] ãƒ­ã‚°ã‚¤ãƒ³å±¥æ­´ã®è¨˜éŒ²ï¼ˆâœ… å®Ÿè£…æ¸ˆã¿ï¼‰
- [ ] æ“ä½œå±¥æ­´ã®è¨˜éŒ²ï¼ˆâœ… å®Ÿè£…æ¸ˆã¿ï¼‰
- [ ] ãƒ­ã‚°é–²è¦§ç”»é¢ï¼ˆç®¡ç†è€…ã®ã¿ï¼‰

---

## ğŸ”§ ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—æ‰‹é †

### 1. Supabaseã§ã®ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œ

1. Supabase Dashboard > SQL Editor ã«ã‚¢ã‚¯ã‚»ã‚¹
2. `migrations/create_auth_tables.sql` ã®å†…å®¹ã‚’ã‚³ãƒ”ãƒ¼
3. SQL Editorã«è²¼ã‚Šä»˜ã‘ã¦å®Ÿè¡Œ

### 2. ç’°å¢ƒå¤‰æ•°ã®ç¢ºèª

ä»¥ä¸‹ã®ç’°å¢ƒå¤‰æ•°ãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèªï¼š

```env
NEXT_PUBLIC_SUPABASE_URL=your_supabase_url
NEXT_PUBLIC_SUPABASE_ANON_KEY=your_supabase_anon_key
SUPABASE_SERVICE_ROLE_KEY=your_service_role_key  # ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ç”¨ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
```

### 3. åˆå›ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ä½œæˆ

Supabase Dashboard > Authentication > Users ã‹ã‚‰æ‰‹å‹•ã§ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ä½œæˆã™ã‚‹ã‹ã€ä»¥ä¸‹ã®SQLã‚’å®Ÿè¡Œï¼š

```sql
-- ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ä½œæˆï¼ˆSupabase Authã‚’ä½¿ç”¨ï¼‰
-- æ³¨æ„: å®Ÿéš›ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½œæˆã¯Supabase Dashboardã‹ã‚‰è¡Œã†ã“ã¨ã‚’æ¨å¥¨

-- ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½œæˆå¾Œã€user_profilesãƒ†ãƒ¼ãƒ–ãƒ«ã«ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚’è¿½åŠ 
INSERT INTO public.user_profiles (id, email, name, role)
VALUES (
  'user-uuid-from-auth-users',
  'admin@example.com',
  'Admin User',
  'admin'
);
```

### 4. å‹•ä½œç¢ºèª

1. é–‹ç™ºã‚µãƒ¼ãƒãƒ¼ã‚’èµ·å‹•: `npm run dev`
2. `/login` ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ãƒ­ã‚°ã‚¤ãƒ³
3. ç®¡ç†è€…æ¨©é™ã§ãƒ­ã‚°ã‚¤ãƒ³ã—ãŸå ´åˆã€`/admin/documents` ã¨ `/admin/upload` ã«ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½
4. ä¸€èˆ¬ãƒ¦ãƒ¼ã‚¶ãƒ¼ã§ãƒ­ã‚°ã‚¤ãƒ³ã—ãŸå ´åˆã€`/ask` ã®ã¿ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½

---

## âš ï¸ æ³¨æ„äº‹é …

1. **æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã®ç§»è¡Œ**
   - æ—¢å­˜ã®æ–‡æ›¸ãƒ‡ãƒ¼ã‚¿ã« `created_by` ã‚’è¨­å®šã™ã‚‹å¿…è¦ãŒã‚ã‚‹å ´åˆãŒã‚ã‚Šã¾ã™
   - å¿…è¦ã«å¿œã˜ã¦ã€æ—¢å­˜æ–‡æ›¸ã® `created_by` ã‚’ç®¡ç†è€…ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«è¨­å®šã—ã¦ãã ã•ã„

2. **RLSãƒãƒªã‚·ãƒ¼ã®ç¢ºèª**
   - RLSãƒãƒªã‚·ãƒ¼ãŒæ­£ã—ãå‹•ä½œã—ã¦ã„ã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„
   - å¿…è¦ã«å¿œã˜ã¦ã€Supabase Dashboard > Authentication > Policies ã§ç¢ºèª

3. **ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†**
   - ã‚»ãƒƒã‚·ãƒ§ãƒ³ã¯Supabase AuthãŒè‡ªå‹•ç®¡ç†ã—ã¾ã™
   - ãƒˆãƒ¼ã‚¯ãƒ³ã®æœ‰åŠ¹æœŸé™ã¯24æ™‚é–“ï¼ˆã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ï¼‰ã€7æ—¥ï¼ˆãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ãƒˆãƒ¼ã‚¯ãƒ³ï¼‰

---

## ğŸ“š å‚è€ƒè³‡æ–™

- [Supabase Auth Documentation](https://supabase.com/docs/guides/auth)
- [Next.js Middleware](https://nextjs.org/docs/app/building-your-application/routing/middleware)
- [Row Level Security (RLS)](https://supabase.com/docs/guides/auth/row-level-security)
- [AUTH_REQUIREMENTS.md](./AUTH_REQUIREMENTS.md) - è©³ç´°ãªè¦ä»¶å®šç¾©

---

**å®Ÿè£…è€…**: AI Assistant  
**ãƒ¬ãƒ“ãƒ¥ãƒ¼**: æœªå®Ÿæ–½  
**æ‰¿èª**: æœªæ‰¿èª

